= garage-sign
ifdef::env-github[]

[NOTE]
====
We recommend that you link:https://docs.ota.here.com/ota-client/latest/{docname}.html[view this article in our documentation portal]. Not all of our articles render correctly in GitHub.
====
endif::[]



xref:https://github.com/advancedtelematic/ota-tuf/tree/master/cli[garage-sign] is a tool for managing your OTA Connect software repository and securely signing software versions. It allows you to directly change, sign, and upload your xref:uptane.adoc[Uptane] metadata.

.Why use `garage-sign`
****
`garage-sign` is useful in OTA Connect for managing the keys for signing your software. If your software image is not an OSTree image, you would need `garage-sign` to Uptane metadata.

* Offline keys
In a production environment, we recommend that you keep the keys for signing software versions offline. Therefore, the OTA Connect server will no longer sign software for you, instead they will be signed locally by your machine. This maintains the security of the software because if someone gained access to your OTA Connect account they will be able to send malicious software to your devices. However if your keys are offline, your devices will not recognise the software as it will not have the correct credentials. This is where `garage-sign` becomes useful. For non-OSTree images, the `garage-sign` tool is used to manage and rotate your keys offline as well as sign your software.


* Local repository
A repository is a location for storing software packages. A local repository is a server that exists on your local machine such as your computer. When using the `garage-sign` tool it is important to create a local repository on your machine that contains your credentials from OTA Connect and your keys for signing metadata. With your keys existing locally on your machine, any changes you make to them will not directly affect your devices on OTA Connect. It also ensures the security of your keys in production as mentioned

****


== Prerequisites of `garage-sign`

. Download the latest version of the `garage-sign` tool from link:https://ats-tuf-cli-releases.s3-eu-central-1.amazonaws.com/index.html[here].
. Unzip the file you have downloaded to a location on your computer, and change the directory of your terminal to that location.
. Afterwards, open the `garage-sign` folder in your terminal. You can also print the help command to view the list of all possible commands with this tool.
+
[source,bash]
----
cd garage-sign/
bin/garage-sign --help
----

For more information, please refer to the link:https://github.com/advancedtelematic/ota-tuf/tree/master/cli[`garage-sign` README file].


== Use of `garage-sign` with OTA Connect

To use the `garage-sign` tool with OTA Connect, you need to perform the following steps:

. Initialize a new image repository locally on your computer that pulls your `credentials.zip` from OTA Connect.
+
[source, bash]
----
garage-sign init \
  --repo <reponame> \ <1>
  --credentials </path/to/credentials.zip> <2>
----
+
<1> The name of your image repository which is to be initialized by the `init` command is provided here.
<2> Here you provide the path of your `credentials.zip` file downloaded from your account on the https://connect.ota.here.com[OTA Connect Portal].
. Ensure you have the latest `targets.json` file by pulling it from OTA Connect.
+
[source, bash]
----
garage-sign targets pull --repo <reponame>
----

The above commands create a local repository in a directory called `/tuf/<reponame>`. This directory will contain your `credentials.zip` file and has a tree structure as shown below:

[source, bash]
----
tuf/<reponame>
├── config.json
├── credentials.zip
├── keys
│   ├── targets.pub <1>
│   └── targets.sec <2>
└── roles
    ├── root.json   <3>
    ├── targets.json.checksum
    └── unsigned
        └── targets.json <4>
----

<1> The public part of your `targets` key
<2> The private part of your `targets` key
<3> The `root.json` metadata file
<4> The `targets.json` metadata file



== Use cases of `garage-sign` with OTA Connect

In most use cases, more than one `garage-sign` command is used to perform a specific task. A few use cases will be discussed in this section, however the use of the `garage-sign` tool is not limited to these.

// tag::rotate-steps[]

=== Generate new keys

You might generate new keys if you:

* xref:rotating-signing-keys.adoc#_rotate_the_online_keys_with_your_new_offline_keys[want to rotate your online keys with your new offline keys]
* believe your keys have been compromised
* would like to revoke the current keys for signing metadata

==== Workflow to generate new keys

When generating new keys for metadata, you perform the following steps:

. First, generate the new `root` and `targets` keys by running the command `garage-sign key generate` twice.
+
[source,bash]
----
garage-sign key generate \
  --repo <reponame> \
  --name myroot \ <1>
  --type <ed25519|rsa> <2>
garage-sign key generate \
  --repo <reponame> \
  --name mytargets \
  --type <ed25519|rsa>
----
+
<1> You can give any name to the keys you generate, which helps to easily identify between the new `root` and `targets` keys. Here, the keys generated are given the names `myroot` and `mytargets`.
<2> The key type must be specified as either Ed25519 or RSA. In OTA Connect, an RSA key is used for signing uptane metadata.
. Afterwards, pull the latest `targets.json` file from OTA Connect with the command `garage-sign targets pull`.
+
[source,bash]
----
garage-sign targets pull --repo <reponame>
----
. Next, use the command `garage-sign move-offline`. This command deletes the old `root` key from OTA Connect, downloads and signs the new `root` key with the newly generated keys, and pushes the new `root.json` file to OTA Connect.
+
[source,bash]
----
garage-sign move-offline \
  --repo <reponame> \
  --old-root-alias originroot \ <1>
  --new-root myroot \ <2>
  --new-targets mytargets <3>
----
+
<1> This is an example of an alias given to the old `root` key. It gets saved with this name.
<2> This is an example of the name given to your new `root` key which you previously generated using the command `garage-sign key generate`.
<3> This is an example of the name given to your new `targets` key which you previously generated using the command `garage-sign key generate`.
. As a final step, sign the new `targets.json` with your newly generated `targets` key and upload it to OTA Connect.
+
[source,bash]
----
garage-sign targets sign --repo <reponame> --key-name mytargets
garage-sign targets push --repo <reponame>
----



Please refer to xref:rotating-signing-keys.adoc#_rotate_the_keys_for_root_and_targets_metadata[rotating the keys for `root` and `targets` metadata] for additional information on generating new keys.

// end::rotate-steps[]


=== Add a new software version

//In the https://connect.ota.here.com[OTA Connect Portal], you can upload ostree images to update your devices.

`garage-sign` can also be used to add software packages to your repository with the command `garage-sign targets add`. The packages are downloaded by aktualizr, however `garage-sign` doesn't upload the software file. The `garage-sign targets add` commmand puts new metadata in place, hence you need to tell aktualizr where the software package can be found. This is done by uploading the file somewhere else and providing `garage-sign` with the URL of where it's available.

//The software package must first be uploaded via a URL and this URL is given to the command `garage-sign targets add` which tells aktualizr where to download the file from. Usually when aktualizr tries to download a file, it looks for it at a specific location in the repository based on its name.

// When aktualizr tries to download a file, it first looks for it at a specific place in the repo based on its name. But when you use garage-sign targets add, you're just putting new metadata in place--you still need to tell aktualizr where it can find the file that the metadata is talking about. Since garage-sign doesn't upload the file for you, you need to upload it somewhere yourself, and provide garage-sign with a URL where it's available so that aktualizr can go get it.

An example of uploading a new software package is shown below.

[source,bash]
----
!#/bin/bash
set -ex
file=$1
s3_bucket=$2
packagename=$3
version=$4
hwid=$5
keyname=$6
url="http://${s3_bucket}.s3.amazonaws.com/${file}" <1>
aws s3 cp "${file}" "s3://${s3_bucket}/${file}"
garage-sign targets add \
  --repo ${reponame} \
  --format binary \ <2>
  --length $(wc -c <"${file}") \ <3>
  --name ${packagename} \
  --version ${version} \ <4>
  --sha256 $(sha256sum "${file}" |cut -d' ' -f-1) \ <5>
  --hardwareids ${hwid} \
  --url ${url} <6>
garage-sign targets sign \
  --repo ${reponame} \
  --key-name ${keyname}
garage-sign targets push \
  --repo ${reponame}
----

<1> The URL of where the software package is uploaded.
<2> You must specify the format of the target image to be added--either as an ostree or binary image. In OTA Connect, the `garage-sign` tool is often used to upload `binary` images.
<3> The length of the image to be added must be specified in bytes.
<4> You must also specify the version number of the target image.
<5> The sha256 hash of the software image is specified here.
<6> The URL of the software package is specified here for `garage-sign` so that aktualizr will know where to find the software file to download.


=== Define metadata expiry

You can also define an expiry date for your metadata using `garage-sign` on the command line. You can do this in two ways, but only one type of expiry argument must be used to define the metadata expiry date.

==== Define a fixed date and time for metadata expiry

Use the following format of `garage-sign` to define a specific time in UTC for metadata to expire:

[source,bash]
----
garage-sign targets sign \
  --expires 2018-01-01T00:01:00Z \ <1>
  --repo <reponame> \
  --key-name mytargets
----

<1> This is an example of specifying a date and time of expiry as an instance in UTC. After this fixed date and time, metadata will no longer be valid.

==== Define a period for metadata expiry

Use the following format of `garage-sign` to specify a period for metadata to be valid:

[source,bash]
----
garage-sign targets sign \
  --expire-after 1Y3M5D \ <1>
  --repo <reponame> \
  --key-name mytargets
----

<1> This is an example of specifying a period for the expiry of metadata. The expiration period is defined in the order of years, months and days, (each optional but in this specified order).

For additional information, please refer to xref:metadata-expiry.adoc[managing metadata expiry dates] in our guide.
